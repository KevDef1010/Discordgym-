generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id         String          @id @default(cuid())
  discordId  String          @unique
  username   String          @unique
  email      String          @unique
  password   String?
  avatar     String?
  createdAt  DateTime        @default(now())
  updatedAt  DateTime        @updatedAt
  isActive   Boolean         @default(true)
  role       UserRole        @default(MEMBER)
  displayId  String?         @unique
  progress   Progress[]
  servers    ServerMember[]
  challenges UserChallenge[]
  workouts   Workout[]
  
  // Freundschaften - ausgehende Anfragen
  sentFriendships     Friendship[] @relation("FriendshipSender")
  // Freundschaften - eingehende Anfragen  
  receivedFriendships Friendship[] @relation("FriendshipReceiver")
  
  // Chat System Relations
  ownedChatServers    ChatServer[]       @relation("ChatServerOwner")
  chatServerMembers   ChatServerMember[] @relation("ChatServerMembers")
  sentMessages        ChatMessage[]      @relation("SentMessages")
  receivedMessages    ChatMessage[]      @relation("ReceivedMessages")
  messageReactions    MessageReaction[]  @relation("MessageReactions")
  createdInvites      ChatServerInvite[] @relation("CreatedInvites")

  @@map("users")
}

model Server {
  id         String         @id @default(cuid())
  discordId  String         @unique
  name       String
  icon       String?
  ownerId    String
  isActive   Boolean        @default(true)
  createdAt  DateTime       @default(now())
  updatedAt  DateTime       @updatedAt
  challenges Challenge[]
  members    ServerMember[]

  @@map("servers")
}

model Friendship {
  id         String           @id @default(cuid())
  senderId   String
  receiverId String
  status     FriendshipStatus @default(PENDING)
  createdAt  DateTime         @default(now())
  updatedAt  DateTime         @updatedAt
  
  sender   User @relation("FriendshipSender", fields: [senderId], references: [id], onDelete: Cascade)
  receiver User @relation("FriendshipReceiver", fields: [receiverId], references: [id], onDelete: Cascade)
  
  @@unique([senderId, receiverId])
  @@map("friendships")
}

model ServerMember {
  id       String     @id @default(cuid())
  userId   String
  serverId String
  role     MemberRole @default(MEMBER)
  joinedAt DateTime   @default(now())
  server   Server     @relation(fields: [serverId], references: [id], onDelete: Cascade)
  user     User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, serverId])
  @@index([serverId], map: "server_members_serverId_fkey")
  @@map("server_members")
}

model Workout {
  id             String      @id @default(cuid())
  userId         String
  name           String
  description    String?
  type           WorkoutType
  duration       Int?
  caloriesBurned Int?
  date           DateTime    @default(now())
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt
  exercises      Exercise[]
  user           User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId], map: "workouts_userId_fkey")
  @@map("workouts")
}

model Exercise {
  id        String  @id @default(cuid())
  workoutId String
  name      String
  sets      Int?
  reps      Int?
  weight    Float?
  distance  Float?
  duration  Int?
  notes     String?
  order     Int     @default(0)
  workout   Workout @relation(fields: [workoutId], references: [id], onDelete: Cascade)

  @@index([workoutId], map: "exercises_workoutId_fkey")
  @@map("exercises")
}

model Challenge {
  id           String          @id @default(cuid())
  serverId     String
  name         String
  description  String
  type         ChallengeType
  target       Float
  unit         String
  startDate    DateTime
  endDate      DateTime
  isActive     Boolean         @default(true)
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt
  server       Server          @relation(fields: [serverId], references: [id], onDelete: Cascade)
  participants UserChallenge[]

  @@index([serverId], map: "challenges_serverId_fkey")
  @@map("challenges")
}

model UserChallenge {
  id          String    @id @default(cuid())
  userId      String
  challengeId String
  progress    Float     @default(0)
  completed   Boolean   @default(false)
  joinedAt    DateTime  @default(now())
  completedAt DateTime?
  challenge   Challenge @relation(fields: [challengeId], references: [id], onDelete: Cascade)
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, challengeId])
  @@index([challengeId], map: "user_challenges_challengeId_fkey")
  @@map("user_challenges")
}

model Progress {
  id        String       @id @default(cuid())
  userId    String
  type      ProgressType
  value     Float
  unit      String
  date      DateTime     @default(now())
  notes     String?
  createdAt DateTime     @default(now())
  user      User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId], map: "progress_userId_fkey")
  @@map("progress")
}

enum FriendshipStatus {
  PENDING
  ACCEPTED
  DECLINED
  BLOCKED
}

enum UserRole {
  SUPER_ADMIN
  ADMIN
  MODERATOR
  TRAINER
  PREMIUM_USER
  MEMBER
  GUEST
}

enum MemberRole {
  OWNER
  ADMIN
  MODERATOR
  TRAINER
  VIP
  MEMBER
  GUEST
}

enum WorkoutType {
  CARDIO
  STRENGTH
  FLEXIBILITY
  SPORTS
  HIIT
  YOGA
  CROSSFIT
  OTHER
}

enum ChallengeType {
  STEPS
  DISTANCE
  WEIGHT_LOSS
  WORKOUT_COUNT
  DURATION
  CALORIES
  CUSTOM
}

enum ProgressType {
  WEIGHT
  BODY_FAT
  MUSCLE_MASS
  MEASUREMENTS
  OTHER
}

// Chat System Models
model ChatServer {
  id          String              @id @default(cuid())
  name        String
  description String?
  avatar      String?
  ownerId     String
  isPrivate   Boolean             @default(false)
  inviteCode  String?             @unique
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt
  
  owner       User                @relation("ChatServerOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  members     ChatServerMember[]
  channels    ChatChannel[]
  invites     ChatServerInvite[]
  
  @@map("chat_servers")
}

model ChatServerMember {
  id           String             @id @default(cuid())
  userId       String
  chatServerId String
  role         ChatServerRole     @default(MEMBER)
  joinedAt     DateTime           @default(now())
  
  user         User               @relation("ChatServerMembers", fields: [userId], references: [id], onDelete: Cascade)
  chatServer   ChatServer         @relation(fields: [chatServerId], references: [id], onDelete: Cascade)
  
  @@unique([userId, chatServerId])
  @@map("chat_server_members")
}

model ChatChannel {
  id           String         @id @default(cuid())
  name         String
  description  String?
  chatServerId String
  isPrivate    Boolean        @default(false)
  position     Int            @default(0)
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  
  chatServer   ChatServer     @relation(fields: [chatServerId], references: [id], onDelete: Cascade)
  messages     ChatMessage[]
  
  @@map("chat_channels")
}

model ChatMessage {
  id          String            @id @default(cuid())
  content     String            @db.Text
  senderId    String
  channelId   String?           // For server channels
  receiverId  String?           // For direct messages
  messageType ChatMessageType   @default(TEXT)
  isEdited    Boolean           @default(false)
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  
  sender      User              @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade)
  receiver    User?             @relation("ReceivedMessages", fields: [receiverId], references: [id], onDelete: Cascade)
  channel     ChatChannel?      @relation(fields: [channelId], references: [id], onDelete: Cascade)
  reactions   MessageReaction[]
  
  @@map("chat_messages")
}

model MessageReaction {
  id        String      @id @default(cuid())
  messageId String
  userId    String
  emoji     String
  createdAt DateTime    @default(now())
  
  message   ChatMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)
  user      User        @relation("MessageReactions", fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([messageId, userId, emoji])
  @@map("message_reactions")
}

model ChatServerInvite {
  id           String      @id @default(cuid())
  code         String      @unique
  chatServerId String
  createdById  String
  expiresAt    DateTime?
  maxUses      Int?
  uses         Int         @default(0)
  createdAt    DateTime    @default(now())
  
  chatServer   ChatServer  @relation(fields: [chatServerId], references: [id], onDelete: Cascade)
  createdBy    User        @relation("CreatedInvites", fields: [createdById], references: [id], onDelete: Cascade)
  
  @@map("chat_server_invites")
}

enum ChatServerRole {
  OWNER
  ADMIN
  MOD
  MEMBER
}

enum ChatMessageType {
  TEXT
  IMAGE
  FILE
  SYSTEM
}
